#--------------------------------------------------------------------------------------------
# Установка простейшего маршрутизатора с NAT для внутренней тестовой сети.
# Порядок настройки.
# Пересылка пакетов из внутренней сети во внешнюю должна работать в такой конфигурации.
#--------------------------------------------------------------------------------------------

[root@slinux ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000
    link/ether 08:00:27:fe:18:5b brd ff:ff:ff:ff:ff:ff
    inet 192.168.115.100/24 brd 192.168.115.255 scope global enp0s8
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fefe:185b/64 scope link
       valid_lft forever preferred_lft forever
3: enp0s9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000
    link/ether 08:10:24:44:38:a3 brd ff:ff:ff:ff:ff:ff
    inet 192.168.62.100/24 brd 192.168.92.255 scope global enp0s9
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe44:38a3/64 scope link
       valid_lft forever preferred_lft forever
4: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:ba:e3:27 brd ff:ff:ff:ff:ff:ff
    inet 192.168.110.100/24 brd 192.168.110.255 scope global enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:feba:e327/64 scope link
       valid_lft forever preferred_lft forever
5: enp0s10: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:71:4b:d7 brd ff:ff:ff:ff:ff:ff
    inet 192.168.120.100/24 brd 192.168.120.255 scope global enp0s10
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe71:4bd7/64 scope link
       valid_lft forever preferred_lft forever

[root@slinux ~]# iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

[root@slinux ~]# cat /etc/sysconfig/iptables
# Generated by iptables-save v1.8.7 on Thu May 16 21:12:57 2024
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
# Completed on Thu May 16 21:12:57 2024
# Generated by iptables-save v1.8.7 on Thu May 16 21:12:57 2024
*mangle
:PREROUTING ACCEPT [883:94852]
:INPUT ACCEPT [882:94776]
:FORWARD ACCEPT [1:76]
:OUTPUT ACCEPT [693:133821]
:POSTROUTING ACCEPT [797:151550]
COMMIT
# Completed on Thu May 16 21:12:57 2024
# Generated by iptables-save v1.8.7 on Thu May 16 21:12:57 2024
*filter
:INPUT ACCEPT [881:94474]
:FORWARD ACCEPT [1:76]
:OUTPUT ACCEPT [692:133519]
COMMIT
# Completed on Thu May 16 21:12:57 2024
[root@slinux ~]# systemctl enable iptables.service
Synchronizing state of iptables.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable iptables
Created symlink /etc/systemd/system/basic.target.wants/iptables.service → /lib/systemd/system/iptables.service.
[root@slinux ~]# systemctl start iptables.service
[root@slinux ~]# systemctl status iptables.service
● iptables.service - IPv4 firewall with iptables
     Loaded: loaded (/lib/systemd/system/iptables.service; enabled; vendor preset: disabled)
     Active: active (exited) since Thu 2024-05-16 21:13:31 MSK; 5s ago
    Process: 31570 ExecStart=/etc/init.d/iptables start (code=exited, status=0/SUCCESS)
   Main PID: 31570 (code=exited, status=0/SUCCESS)
        CPU: 22ms

мая 16 21:13:31 slinux.testlab.lan systemd[1]: Starting IPv4 firewall with iptables...
мая 16 21:13:31 slinux.testlab.lan iptables[31581]: Applying iptables firewall rules: succeeded
мая 16 21:13:31 slinux.testlab.lan iptables[31570]: Applying iptables firewall rules: [ DONE ]
мая 16 21:13:31 slinux.testlab.lan systemd[1]: Finished IPv4 firewall with iptables.
[root@slinux ~]#

[root@slinux ~]# iptables -P INPUT ACCEPT
[root@slinux ~]# iptables -P OUTPUT ACCEPT
[root@slinux ~]# iptables -P FORWARD ACCEPT
[root@slinux ~]# iptables -t nat -A POSTROUTING -s 192.168.110.0/24 -d 0/0 -o enp0s9 -j SNAT --to-source 192.168.62.100
[root@slinux ~]# iptables -A FORWARD -i enp0s3 -o enp0s9 -s 192.168.110.0/24 -j ACCEPT
[root@slinux ~]# iptables -A FORWARD -i enp0s9 -o enp0s3 -m state --state ESTABLISHED,RELATED -j ACCEPT

[root@slinux ~]# iptables -L -vn
Chain INPUT (policy ACCEPT 32 packets, 1949 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     all  --  enp0s3 enp0s9  192.168.110.0/24     0.0.0.0/0
    0     0 ACCEPT     all  --  enp0s9 enp0s3  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED

Chain OUTPUT (policy ACCEPT 21 packets, 1573 bytes)
 pkts bytes target     prot opt in     out     source               destination

[root@slinux ~]# iptables-save > /etc/sysconfig/iptables
[root@slinux ~]# cat /etc/sysconfig/iptables

[root@slinux ~]# iptables-save > /etc/sysconfig/iptables
[root@slinux ~]# cat /etc/sysconfig/iptables
# Generated by iptables-save v1.8.7 on Thu May 16 21:15:42 2024
*nat
:PREROUTING ACCEPT [1:240]
:INPUT ACCEPT [1:240]
:OUTPUT ACCEPT [5:365]
:POSTROUTING ACCEPT [5:365]
-A POSTROUTING -s 192.168.110.0/24 -o enp0s9 -j SNAT --to-source 192.168.62.100
COMMIT
# Completed on Thu May 16 21:15:42 2024
# Generated by iptables-save v1.8.7 on Thu May 16 21:15:42 2024
*mangle
:PREROUTING ACCEPT [247:15181]
:INPUT ACCEPT [247:15181]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [167:16913]
:POSTROUTING ACCEPT [171:17205]
COMMIT
# Completed on Thu May 16 21:15:42 2024
# Generated by iptables-save v1.8.7 on Thu May 16 21:15:42 2024
*filter
:INPUT ACCEPT [80:4729]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [54:5985]
-A FORWARD -s 192.168.110.0/24 -i enp0s3 -o enp0s9 -j ACCEPT
-A FORWARD -i enp0s9 -o enp0s3 -m state --state RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Thu May 16 21:15:42 2024
[root@slinux ~]#

[root@slinux ~]# echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf
[root@slinux ~]# sysctl -p
[root@slinux ~]# cat /etc/sysctl.conf
# sysctl settings are defined through files in
# /lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.
#
# Vendors settings live in /lib/sysctl.d/.
# To override a whole file, create a new file with the same in
# /etc/sysctl.d/ and put new settings there. To override
# only specific settings, add a file with a lexically later
# name in /etc/sysctl.d/ and put new settings there.
#
# For more information, see sysctl.conf(5) and sysctl.d(5).
net.ipv4.ip_forward = 1


